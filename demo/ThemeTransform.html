<!doctype html>
<html>

  <head>
    <meta charset=utf-8>
    <title>ThemeTransform</title>
    <style>
      :root {
        --control-panel-theme-visibility: visible;
        --control-panel-page-protection-visibility: visibile;
      }
      body {
        padding: 20px 20px 20px 300px !important;
      }
      .content_block {
        padding-bottom: 50px;
      }
      #theme_demo_menu a {
        display: block;
        color: black;
        font-size: 0.75em;
        white-space: nowrap;
      }
      #theme_demo_tools {
        background: #ccc;
        padding: 15px;
        position: fixed;
        left: 20px;
        top: 20px;
        z-index: 10000;
        width: 230px;
        border-radius: 8px;
      }
      .theme_demo_article_title {
        color: red;
        font-size: 2.0em;
      }
    </style>
 
    <link href="https://en.wikipedia.org/w/load.php?debug=false&lang=en&only=styles&skin=vector&modules=skins.minerva.base.reset|skins.minerva.content.styles|ext.math.styles|" rel="stylesheet" type="text/css"></link>

    <script src=build/wikimedia-page-library-transform.js></script>
    <link rel=import href=ControlPanel.html>
  </head>

  <body>
    <div id='theme_demo_tools'>
      <control-panel></control-panel>
      <div id='theme_demo_menu'></div>
    </div>
    <div class='content' id='content'></div>
    
    <script>
/* eslint-disable require-jsdoc */

const flattenArrayOfArrays = array => [].concat(...array)

const fileNamesFromArticlesJSON =
  json => json.map(article => `${article.lang}.${article.title}.${article.revision}.json`)

const anchorsFromFileNames = fileNames => fileNames.map(fileName => {
  const anchor = document.createElement('a')
  anchor.href = `#${fileName}`
  anchor.innerHTML = fileName
  return anchor
})

const articleJSONFetchPromisesFromURLs =
  urls => urls.map(url => fetch(url).then(resp => resp.json()))

// 'DemoArticles' json files were saved using the mobileview parameters in the URL below.
// eslint-disable-next-line max-len
// https://en.wikipedia.org/w/api.php?action=mobileview&format=json&noheadings=true&page=Playwright&pilicense=any&prop=sections%7Ctext%7Clastmodified%7Clastmodifiedby%7Clanguagecount%7Cid%7Cprotection%7Ceditable%7Cdisplaytitle%7Cthumb%7Cdescription%7Cimage%7Crevision%7Cnamespace&sectionprop=toclevel%7Cline%7Canchor%7Clevel%7Cnumber%7Cfromtitle%7Cindex&sections=all&thumbwidth=640
const urlsFromFileNames = fileNames => fileNames.map(filename => `/DemoArticles/data/${filename}`)

const sectionsFromAllArticlesJSONs = jsons => jsons.map(json => json.mobileview.sections)

const sectionsFromAllArticlesSections =
  allArticlesSections => flattenArrayOfArrays(allArticlesSections)

const enclosedSectionHTMLsFromSections = sections => sections.map(section =>
  `<div class='content_block' id='${section.id}'>
      <h2>${section.line}</h2>
      <br>${section.text}
    </div>`)

const htmlFromAllSectionHTMLs = allSectionHTMLs => allSectionHTMLs.join('')

const addHTMLToDocument = html => {
  const contentElement = document.querySelector('#content')
  contentElement.innerHTML = html
}

const addSectionTitles = fileNames => {
  Array.from(document.querySelectorAll('.content_block[id="0"] h2:first-of-type'))
    .forEach((h2, id) => {
      const title = fileNames[parseInt(id, 10)]
      h2.innerHTML = title
      h2.classList.add('theme_demo_article_title')
      h2.id = title // Used by menu at top for jumping to articles.
    })
}

const addEditPencils = () => {
  let index = 0
  document.querySelectorAll('h2, h3, h4, h5, h6').forEach(header => {
    /* global pagelib */
    const button = pagelib.EditTransform.newEditSectionButton(document, index)
    header.parentNode.insertBefore(button, header)
    ++index
  })
}

// Layout the article section data consecutively on a single page. Comment out any files above you 
// aren't interested in testing, then when finished double-check all of them.
const addHTMLFromJSONFilesToDocument = fileNames => {
  Promise.all(articleJSONFetchPromisesFromURLs(urlsFromFileNames(fileNames)))
    .then(sectionsFromAllArticlesJSONs)
    .then(sectionsFromAllArticlesSections)
    .then(enclosedSectionHTMLsFromSections)
    .then(htmlFromAllSectionHTMLs)
    .then(addHTMLToDocument)
    .then(() => addSectionTitles(fileNames))
    .then(addEditPencils)
}

const addAnchorsToMenu = anchors => {
  const themeDemoMenu = document.getElementById('theme_demo_menu')
  anchors.forEach(anchor => themeDemoMenu.appendChild(anchor))
}

fetch('./DemoArticles/articles.json')
  .then(response => response.json())
  .then(fileNamesFromArticlesJSON)
  .then(fileNames => {
    addHTMLFromJSONFilesToDocument(fileNames)
    return fileNames
  })
  .then(anchorsFromFileNames)
  .then(addAnchorsToMenu)

    </script>
</body>
</html>